
<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="chrome=1">

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<link rel="stylesheet" href="reveal.js/css/reveal.css">
<link rel="stylesheet" href="reveal.js/css/theme/simple.css" id="theme">

<!-- For syntax highlighting -->
<link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

<!-- If the query includes 'print-pdf', use the PDF print sheet -->
<script>
document.write( '<link rel="stylesheet" href="reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
</script>

<!--[if lt IE 9]>
<script src="reveal.js/lib/js/html5shiv.js"></script>
<![endif]-->



<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
.reveal {
font-size: 20px;
overflow-y: auto;
overflow-x: hidden;
}
.reveal pre {
width: 98%;
padding: 0.4em;
margin: 0px;
font-family: monospace, sans-serif;
font-size: 80%;
box-shadow: 0px 0px 0px rgba(0, 0, 0, 0);
}
.reveal section img {
border: 0px solid black;
box-shadow: 0 0 10px rgba(0, 0, 0, 0);
}
.reveal .slides {
text-align: left;
}
div.input_area {
padding: 0.06em;
}
div.code_cell {
background-color: transparent;
}
div.prompt {
width: 11ex;
padding: 0.4em;
margin: 0px;
font-family: monospace, sans-serif;
font-size: 80%;
text-align: right;
}
div.output_area pre {
font-family: monospace, sans-serif;
font-size: 80%;
}
div.output_prompt {
    /* 5px right shift to account for margin in parent container */
    margin: 5px 5px 0 -5px;
}
</style>
</head>

<body>
<div class="reveal"><div class="slides">

<section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h1>PyOP2: a Framework for Performance-Portable Unstructured Mesh-based Simulations and its Application to Finite-Element Computations</h1>
<h3>Florian Rathgeber<sup>1</sup>, Graham Markall<sup>1</sup>, Lawrence Mitchell<sup>3</sup>, Nicolas Loriant<sup>1</sup>, David Ham<sup>1,2</sup>, Gheorghe-teodor Bercea<sup>1</sup>, Fabio Luporini<sup>1</sup>, Paul Kelly<sup>1</sup></h3>
<h4><sup>1</sup> Department of Computing, Imperial College London</h4>
<h4><sup>2</sup> Grantham Institute for Climate Change, Imperial College London</h4>
<h4><sup>3</sup> EPCC, University of Edinburgh</h4>
<p>Slides: <a href="http://kynan.github.io/SciPy2013">http://kynan.github.io/SciPy2013</a></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>PyOP2 from a SciPy Perspective</h2>
<h3>High-level structure</h3>
<ul>
<li>SciPy is about producing high level interfaces to numerical computing</li>
<li>PyOP2: a high-level interface to unstructured mesh based methods<ul>
<li>Efficiently execute kernels over an unstructured grid in parallel</li>
</ul>
</li>
<li>Firedrake: a performance-portable finite-element computation framework<ul>
<li>Drive FE computations from a high-level problem specification</li>
</ul>
</li>
</ul>
<h3>Low-level operations</h3>
<ul>
<li>Separating the low-level implementation from the high-level problem specification</li>
<li>Many-core hardware has brought a paradigm shift to CSE</li>
<li>Generate platform-specific implementations from a common source instead of hand-coding them</li>
<li>Runtime code generation and JIT compilation open space for compiler-driven optimizations and performance portability</li>
</ul>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="FEM" src="images/fem.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>UFL: Domain-specific language for FE forms</h2>
<p>UFL is the <a href="https://bitbucket.org/fenics-project/ufl">Unified Form Language</a> from the <a href="http://fenicsproject.org">FEniCS project</a>.</p>
<h3>The weak form of the Helmholtz equation</h3>
<p>$$\int_\Omega \nabla v \cdot \nabla u - \lambda v u ~dV = \int_\Omega v f ~dV$$</p>
<h3>And its literal translation to Python with UFL</h3>
<pre><code>e = FiniteElement('CG', 'triangle', 1)

v = TestFunction(e)
u = TrialFunction(e)
f = Coefficient(e)

lmbda = 1
a = (dot(grad(v), grad(u)) - lmbda * v * u) * dx

L = v*f*dx
</code></pre>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Helmholtz local assembly kernel generated by FFC</h2>
<p>The <a href="https://bitbucket.org/fenics-project/ffc">FEniCS Form Compiler</a> FFC compiles UFL forms to low-level code.</p>
<pre><code>// A - local tensor to assemble
// x - local coordinates
// j, k - 2D indices into the local assembly matrix
void kernel(double A[1][1], double *x[2],
            int j, int k) {
  // FE0 - Shape functions
  // Dij - Shape function derivatives
  // Kij - Jacobian inverse / determinant
  // W3  - Quadrature weights
  // det - Jacobian determinant
  for (unsigned int ip = 0; ip &lt; 3; ip++) {
    A[0][0] += (FE0[ip][j] * FE0[ip][k] * (-1.0)
      + (((K00 * D10[ip][j] + K10 * D01[ip][j]))
        *((K00 * D10[ip][k] + K10 * D01[ip][k]))
      + ((K01 * D10[ip][j] + K11 * D01[ip][j]))
        *((K01 * D10[ip][k] + K11 * D01[ip][k]))
      )) * W3[ip] * det;
  }
}
</code></pre>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>PyOP2 Architecture</h2>
<p><img alt="PyOP2 implementation" src="images/pyop2.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>PyOP2 Partitioning, Staging &amp; Coloring</h2>
<p><img alt="PyOP2 paritioning" src="images/partitioning.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="PyOP2 staging" src="images/staging.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="PyOP2 staging" src="images/coloring.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>The Firedrake/PyOP2 tool chain</h2>
<p><img alt="Firedrake" src="images/firedrake_toolchain.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Separation of concerns</h2>
<p><img alt="Firedrake" src="images/firedrake_toolchain_users.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Driving Finite-element Computations in Firedrake</h2>
<pre><code>import firedrake as fd
from firedrake.ufl import *

# Read a mesh and define function space
mesh = fd.Mesh('filename')
V = fd.FunctionSpace(mesh, "Lagrange", 1)

# Set up the mathematical model
u = TrialFunction(V)
v = TestFunction(V)

lmbda = 1
a = (dot(grad(v), grad(u)) - lmbda * v * u) * dx
L = v * f * dx

# Solve the resulting finite-element equation
fd.solve(a == L, u)
</code></pre>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Using PyOP2 for non-FEM kernels</h2>
<p>PyOP2: performance portability for <em>any</em> unstructured mesh computations, not limited to FEM!</p>
<p>Use PyOP2 kernel for re-normalising a vector field</p>
<pre><code>vec_norm_code="""
void vec_norm(double *u)
{
  const double n = sqrt(u[0]*u[0]+u[1]*u[1]);
  u[0] /= n;
  u[1] /= n;
}
"""

vec_norm = op2.Kernel(vec_norm_code, "vec_norm")

op2.par_loop(vec_norm, nodes,
             u(op2.IdentityMap, op2.RW))
</code></pre>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Speedup relative to single core Fluidity (sequential)</h2>
<p><img alt="speedup" src="parallel_12/speedup_linear_1.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Speedup relative to single core Fluidity (12-node MPI)</h2>
<p><img alt="speedup" src="parallel_12/speedup_linear_2.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Speedup relative to single core Fluidity (GPU)</h2>
<p><img alt="speedup" src="parallel_12/speedup_linear_3.svg" /></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Thank you!</h2>
<p>Contact: Florian Rathgeber, <a href="https://twitter.com/frathgeber">@frathgeber</a> <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#102;&#46;&#114;&#97;&#116;&#104;&#103;&#101;&#98;&#101;&#114;&#64;&#105;&#109;&#112;&#101;&#114;&#105;&#97;&#108;&#46;&#97;&#99;&#46;&#117;&#107;">&#102;&#46;&#114;&#97;&#116;&#104;&#103;&#101;&#98;&#101;&#114;&#64;&#105;&#109;&#112;&#101;&#114;&#105;&#97;&#108;&#46;&#97;&#99;&#46;&#117;&#107;</a></p>
<h3>Resources</h3>
<h4>PyOP2</h4>
<p><a href="https://github.com/OP2/PyOP2">https://github.com/OP2/PyOP2</a></p>
<h4>FFC</h4>
<p><a href="https://bitbucket.org/mapdes/ffc">https://bitbucket.org/mapdes/ffc</a></p>
<h4>Firedrake</h4>
<p><a href="https://code.launchpad.net/~fluidity-core/fluidity/firedrake">https://code.launchpad.net/~fluidity-core/fluidity/firedrake</a></p>
<h4>Benchmarks</h4>
<p><a href="https://github.com/OP2/PyOP2_benchmarks">https://github.com/OP2/PyOP2_benchmarks</a></p>
<h4>This talk</h4>
<p><a href="http://kynan.github.io/SciPy2013">http://kynan.github.io/SciPy2013</a></p>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Firedrake: Performance-portable Finite-element Computation Framework</h2>
<h3>Fluidity</h3>
<p><img alt="Backward-facing step" src="images/BackStep.png" /></p>
<ul>
<li>open source, general purpose, multi-phase computational fluid dynamics code</li>
<li>used internationally for complex fluid tasks</li>
<li>developed at <a href="http://amcg.ese.ic.ac.uk/">AMCG</a> at Imperial College</li>
<li>XML-based configuration files with GUI editor</li>
</ul>
<h3>The Firedrake interface</h3>
<ul>
<li>Fluidity provides Python interface for creating / manipulating global data structures</li>
<li>Users provide mathematical models in UFL code</li>
<li>Firedrake calls PyOP2 instead of Fluidity's built-in solvers</li>
<li>PyOP2 data structures for accessed fields are created on the fly</li>
</ul>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Finite element assembly and solve in Firedrake</h2>
<p>What goes on behind the scenes of the <code>solve</code> call (simplified example!):</p>
<pre><code>from pyop2 import op2, ffc_interface

def solve(equation, x):
    # Generate kernels for matrix and rhs assembly
    lhs = ffc_interface.compile_form(equation.lhs, "lhs")[0]
    rhs = ffc_interface.compile_form(equation.rhs, "rhs")[0]

    # Omitted: extract coordinates (coords), connectivity (elem_node)
    # and coefficients (tracer t, velocity u)

    # Construct OP2 matrix to assemble into
    sparsity = op2.Sparsity((elem_node, elem_node), sparsity_dim) 
    mat = op2.Mat(sparsity, numpy.float64)
    b = op2.Dat(nodes, np.zeros(nodes.size))

    # Assemble lhs, rhs and solve linear system
    op2.par_loop(lhs, elements(3,3),
                 mat((elem_node[op2.i[0]], elem_node[op2.i[1]]), op2.INC),
                 coords(elem_node, op2.READ))
    op2.par_loop(rhs, elements(3),
                 b(elem_node[op2.i[0]], op2.INC),
                 coords(elem_node, op2.READ),
                 t(elem_node, op2.READ),
                 u(elem_node, op2.READ))

    op2.solve(mat, x, b)
</code></pre>
</div></section>
    </section><section>
    <section>
<div class="text_cell_render border-box-sizing rendered_html">
<h2>Comparison to FEniCS</h2>
<p><img alt="Comparison to FEniCS" src="images/firedrake_toolchain_fenics.svg" /></p>
</div></section>
    </section>

</div></div>

<!-- Social buttons
<div class="addthis_toolbox addthis_floating_style addthis_32x32_style" style="left:20px;top:20px;">
<a class="addthis_button_twitter"></a>
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_linkedin"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_more"></a>
</div>
End of social buttons -->

<script src="reveal.js/lib/js/head.min.js"></script>

<script src="reveal.js/js/reveal.min.js"></script>

<script>

// Full list of configuration options available here: https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
controls: true,
progress: true,
history: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/none

// Optional libraries used to extend on reveal.js
dependencies: [
{ src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
{ src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
{ src: 'reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
{ src: 'reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
// { src: 'http://s7.addthis.com/js/300/addthis_widget.js', async: true},
// { src: 'js/mathjax-onload.js', async: true}
]
});
</script>

<!-- MathJax configuration -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
    },
    displayAlign: 'left', // Change this to 'center' to center equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script>
<!-- End of mathjax configuration -->

<script>
//  We wait for the onload function to load MathJax after the page is completely loaded.  
//  MathJax is loaded 1 unit of time after the page is ready.
//  This hack prevent problems when you load multiple js files (i.e. social button from addthis).
//
window.onload = function () {
  setTimeout(function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS_HTML";
    document.getElementsByTagName("head")[0].appendChild(script);
  },1)
}
</script>

<script>
Reveal.addEventListener( 'slidechanged', function( event ) {
MathJax.Hub.Rerender(event.currentSlide);
});
</script>

</body>

</html>
